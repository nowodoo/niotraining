<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Web sockets test</title>
 	<style type="text/css">
	     .container
	     {
	         font-family: "Courier New";
	         width: 680px;
	         height: 300px;
	         overflow: auto;
	         border: 1px solid black;
	     }
	
	     .LockOff {
	         display: none; 
	         visibility: hidden; 
	      } 
	
	      .LockOn { 
	         display: block; 
	         visibility: visible; 
	         position: absolute; 
	         z-index: 999; 
	         top: 0px; 
	         left: 0px; 
	         width: 1024%; 
	         height: 768%; 
	         background-color: #ccc; 
	         text-align: center; 
	         padding-top: 20%; 
	         filter: alpha(opacity=75); 
	         opacity: 0.75; 
	      } 
   </style> 

    <script src="jquery-min.js" type="text/javascript"></script>
    <script src="base.js" type="text/javascript"></script>
    <script type="text/javascript">
      var ws;
      var SocketCreated = false;
      var isUserloggedout = false;
      function lockOn(str) 
      { 
         var lock = document.getElementById('skm_LockPane'); 
         if (lock) 
            lock.className = 'LockOn'; 
         lock.innerHTML = str; 
      } 
      function lockOff()
      {
         var lock = document.getElementById('skm_LockPane'); 
         lock.className = 'LockOff'; 
      }
      function ToggleConnectionClicked() 
      {
            if (SocketCreated && (ws.readyState == 0 || ws.readyState == 1)) 
            {
                lockOn("离开聊天室...");  
                SocketCreated = false;
                isUserloggedout = true;
                ws.close();
            } 
            else
            {
                lockOn("进入聊天室...");  
                Log("准备连接到聊天服务器 ...");
                try 
                {
                    if ("WebSocket" in window) 
                    {
                      ws = new WebSocket("ws://" + document.getElementById("Connection").value);
                    }
                    else if("MozWebSocket" in window) 
                    {
                      ws = new MozWebSocket("ws://" + document.getElementById("Connection").value);
                    }
                    
                    SocketCreated = true;
                    isUserloggedout = false;
                } 
                catch (ex) 
                {
                    Log(ex, "ERROR");
                    return;
                }
                document.getElementById("ToggleConnection").innerHTML = "断开";
                ws.onopen = WSonOpen;
                ws.onmessage = WSonMessage;
                ws.onclose = WSonClose;
                ws.onerror = WSonError;
                ws.binaryType="arraybuffer";
            }
        };
        function WSonOpen() 
        {
            lockOff();
            Log("连接已经建立。", "OK");
            $("#SendDataContainer").show();
            ws.send("login...");
        };
		
        function WSonMessage(event) 
        {
        	/*
			var fileReader = new FileReader();
			fileReader.onload = function() 
			{
				//Log(String.fromCharCode.apply(null, new Uint16Array(this.result)));
				//alert(String.fromCharCode('0x4e2d'));//中
				//alert(String.fromCharCode('0x6587'));//文
			    var int8View = new Uint8Array(this.result);
				for (var i = 0; i < int8View.length; i++) 
				{
					Log(int8View[i]);
				}
				console.log(bin2utf8(int8View));
			};
			fileReader.readAsArrayBuffer(event.data);    
			*/
			console.log(event.data);
            Log(event.data);
        };
        function WSonClose(event) 
        {
            lockOff();
            Log(event.data);
            if (isUserloggedout)
                Log("【"+document.getElementById("txtName").value+"】离开了聊天室！");
            document.getElementById("ToggleConnection").innerHTML = "连接";
            $("#SendDataContainer").hide();
        };
        function WSonError(event) 
        {
            lockOff();
            Log(event.data, "ERROR");
            Log("远程连接中断。", "ERROR");
        };
        function SendDataClicked() 
        {
            if (document.getElementById("DataToSend").value.trim() != "") 
            {
            	//ws.send(parseInt(document.getElementById("DataToSend").value));
                ws.send(document.getElementById("DataToSend").value);
                document.getElementById("DataToSend").value = "";
            }
        };
        function Log(Text, MessageType) 
        {
            if (MessageType == "OK") Text = "<span style='color: green;'>" + Text + "</span>";
            if (MessageType == "ERROR") Text = "<span style='color: red;'>" + Text + "</span>";
            document.getElementById("LogContainer").innerHTML = document.getElementById("LogContainer").innerHTML + Text + "<br />";
            var LogContainer = document.getElementById("LogContainer");
            LogContainer.scrollTop = LogContainer.scrollHeight;
        };
        $(document).ready(function () 
        {
            $("#SendDataContainer").hide();
            var WebSocketsExist = true;
            try 
            {
                var dummy = new WebSocket("ws://localhost:8989/websocket");
            } 
            catch (ex) 
            {
                try
                {
                  webSocket = new MozWebSocket("ws://localhost:8989/websocket");
                }
                catch(ex)
                {
                  WebSocketsExist = false;
                }
            }
            if (WebSocketsExist) {
                Log("您的浏览器支持WebSocket. 您可以尝试连接到聊天服务器!", "OK");
                document.getElementById("Connection").value = "127.0.0.1:8999/webocket";
            } else {
                Log("您的浏览器不支持WebSocket。请选择其他的浏览器再尝试连接服务器。", "ERROR");
                document.getElementById("ToggleConnection").disabled = true;
            }    
            
            $("#DataToSend").keypress(function(evt)
            {
                if (evt.keyCode == 13)
                {
                    $("#SendData").click();
                    evt.preventDefault();
                }
            })        
        });
    </script>
</head>
<body>
    <div id="skm_LockPane" class="LockOff"></div>
    <form id="form1" runat="server">
        <h1>Web Socket 聊天室</h1>
        <br />
        <div>
            按下连接按钮，会通过WebSocket发起一个到聊天浏览器的连接。
        </div>
        服务器地址: <input type="text" id="Connection" /> 用户名： <input type="text" id="txtName" value="冼家明"/>
        <button id='ToggleConnection' type="button" onclick='ToggleConnectionClicked();'>连接</button>
        <br />
        <br />
        <div id='LogContainer' class='container'></div>
        <br />
        <div id='SendDataContainer'>
        <input type="text" id="DataToSend" size="88" />
        <button id='SendData' type="button" onclick='SendDataClicked();'>发送</button>
        </div>
        <br />
    </form>
</body>
</html>